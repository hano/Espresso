#! /bin/sh
set -xeuf

if plugins="$(json-print $file package $target plugins)"; then
  plugins="$(echo "$plugins" | plugins2args)"
  if test -z "$plugins"; then
    : plugins property is empty
    exit 0
  fi
else
  : no plugins property configured
  exit 0
fi

validate-plugins `echo "$plugins" | awk '{print$1}'`

echo "$plugins" | while read name value; do

  # TODO plugin files should be in some appropriate subdirectory of www/

  # copy plugin files
  for i in src libs assets; do
    if test -d app/plugins/$name/$i; then
      tar -C app/plugins/$name -c $i | tar -C android-project -x -v
    fi
  done

  # link js to html
  gsedi android-project/assets/www/index.html "s:</head>:$(
    find app/plugins/$name/assets/www -name '*.js' | sed '
        s:^app/plugins/'"$name"'/assets/www/\(.*\):<script src="\1"></script>:
    ')\n&:"

  # add element to res/xml/plugins.xml
  echo "    <plugin name=\""$name"\" value=\""$value"\" />" \
      >> android-project/res/xml/plugins.xml
done

# move closing tag to the end
gsedi android-project/res/xml/plugins.xml 's:</plugins>::'
echo '</plugins>' \
    >>android-project/res/xml/plugins.xml
